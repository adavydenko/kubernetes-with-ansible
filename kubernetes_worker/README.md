Kubernetes Worker Node Configuration
===================================

This Ansible role configures Kubernetes worker nodes and joins them to an existing Kubernetes cluster. It handles the complete setup process including container runtime installation, system configuration, and cluster joining.

## Overview

The `kubernetes_worker` role automates the setup of Kubernetes worker nodes by:

- Installing required packages and dependencies
- Configuring the container runtime (Docker/containerd)
- Setting up kernel modules and system parameters
- Configuring firewall rules for Kubernetes networking
- Installing Kubernetes components (kubelet, kubeadm, kubectl)
- Joining the worker node to the existing cluster

## Requirements

### System Requirements
- Ubuntu/Debian-based systems
- Root or sudo privileges
- Internet connectivity for package downloads
- At least 2GB RAM and 2 CPU cores recommended

### Ansible Requirements
- Ansible 2.14 or higher
- Python 3.x on target hosts
- SSH access to target hosts

### Prerequisites
- A Kubernetes master node must be configured and running
- The master node should have generated a join command
- Network connectivity between master and worker nodes

## Role Variables

This role uses the following variables from the master node's join command:

- `kubeadm_join_command`: The complete join command generated by the master node

### System Configuration Variables

The role configures the following system parameters:
- Disables swap permanently
- Loads required kernel modules (overlay, br_netfilter)
- Sets kernel parameters for Kubernetes networking
- Configures firewall rules for Kubernetes ports

### Kubernetes Ports Configured

The role opens the following firewall ports:
- `6443/tcp` - Kubernetes API server
- `2379:2380/tcp` - etcd server client API
- `22/tcp` - SSH access
- `8080/tcp` - Kubernetes API server (legacy)
- `10250:10252/tcp` - Kubelet API and kube-scheduler
- `10255/tcp` - Kubelet read-only API
- `5473/tcp` - Calico networking

## Dependencies

This role has no external dependencies but requires:
- A properly configured Kubernetes master node
- The `kubernetes_master` role to be executed first
- Network connectivity between master and worker nodes

## Example Playbook

```yaml
---
- name: Configure Kubernetes worker nodes
  hosts: worker_nodes
  become: true
  roles:
    - kubernetes_worker
```

### Complete Setup Example

```yaml
---
- name: Configure kubernetes master
  hosts: master_nodes
  become: true
  roles:
    - kubernetes_master

- name: Configure kubernetes worker nodes
  hosts: worker_nodes
  become: true
  roles:
    - kubernetes_worker
```

## Role Tasks

The role performs the following main tasks:

1. **Package Installation**: Installs required packages (curl, gpg, apt-transport-https, ca-certificates)
2. **Swap Configuration**: Disables swap permanently
3. **Container Runtime**: Installs and configures Docker/containerd
4. **Kernel Configuration**: Loads required modules and sets kernel parameters
5. **Firewall Setup**: Configures UFW rules for Kubernetes networking
6. **Kubernetes Installation**: Installs kubelet, kubeadm, and kubectl
7. **Service Configuration**: Configures kubelet with proper cgroup driver
8. **Cluster Joining**: Joins the worker node to the existing cluster

## Idempotency

The role is designed to be idempotent:
- Checks for existing Kubernetes configuration before joining
- Uses `creates` parameter to prevent duplicate cluster joining
- Handles package installation safely with `state: present`

## Troubleshooting

### Common Issues

1. **Join Command Not Found**: Ensure the master node has been configured and the join command is available
2. **Firewall Issues**: Check that all required ports are open
3. **Container Runtime Issues**: Verify Docker/containerd is running properly
4. **Network Connectivity**: Ensure master and worker nodes can communicate

### Verification

After role execution, verify the worker node is properly joined:

```bash
# On master node
kubectl get nodes

# On worker node
sudo systemctl status kubelet
```

## License

MIT

## Author Information

**Author**: Aleksandr A. Davydenko

This role is part of a comprehensive Kubernetes deployment automation project using Ansible.
